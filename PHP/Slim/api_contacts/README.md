My Contacts API
===============

* [Blog - Parte I y II](http://www.sitepoint.com/series/build-a-rest-api-from-scratch/)

_Author: Vito Tardia (<vito@tardia.me>)_

This application implements a simple contact list service that manages contacts with linked notes. It has **two object types**, contacts and notes. Each contact has basic attributes such as first name, last name, and email address. Also, each contact can have a number of markdown-formatted notes linked to it.

**This is sample code** for the article "Constructing a full REST API with respect to best practices - Part 1 and 2" written for Sitepoint.

**Install dependencies via `composer install`**

## Create Database (sqlite)

* Create tables: Run `php bin/install development`
* Import tables: Run `php bin/import  development`

## Resources and Actions

    URL                           HTTP Method  Operation
    /api/contacts                 GET          Returns an array of contacts
        Query params:
            - Filtro: q (busca texto contenido), <field_name>
            - Mostrar sólo:  fields
            - Orden: sort
            - Paginacion: page, per_page
        Ejemplo:
            https://api-contacts.com/api/v1/contacts?fields=firstname,email&sort=-email,firstname&q=vitae&firstname=Carlos&page=2&per_page=3    

    /api/contacts/:id             GET          Returns the contact with id of :id
        Query params:
            embed=notes
    /api/contacts                 POST         Adds a new contact and return it with an id attribute added
    /api/contacts/:id             PUT          Updates the contact with id of :id
    /api/contacts/:id             PATCH        Partially updates the contact with id of :id
    /api/contacts/:id             DELETE       Deletes the contact with id of :id

    /api/contacts/:id/star        PUT          Adds to favorites  the contact with id of :id
    /api/contacts/:id/star        DELETE       Removes from favorites  the contact with id of :id

    /api/contacts/:id/notes       GET          Returns the notes for the contact with id of :id
    /api/contacts/:id/notes/:nid  GET          Returns the note with id of :nid for the contact with id of :id
    /api/contacts/:id/notes       POST         Adds a new note for the contact with id of :id
    /api/contacts/:id/notes/:nid  PUT          Updates the note with id if :nid for the contact with id of :id
    /api/contacts/:id/notes/:nid  PATCH        Partially updates the note with id of :nid for the contact with id of :id
    /api/contacts/:id/notes/:nid  DELETE       Deletes the note with id of :nid for the contact with id of :id

Payloads: application/json

## Tecnologias

* [Slim Framework](http://slimframework.com)
    + [Route Groups](http://docs.slimframework.com/#Route-Groups):  group related routes
* [Idiorm](http://j4mie.github.io/idiormandparis/): to access the database layer
* Monolog: logger
* `slim/extras` and `slim/middleware` packages: provide useful features such as content type parsing and basic authentication
* Middlewares:
    + **Cache** (the innermost);  (usa APC extension)
    + ContentTypes: parses JSON-formatted body from the client; (provisto por Slim)
    + **RateLimit**: manages users API limits;
    + **JSON**: utility middleware for “JSON only responses” and “JSON encoded bodies” best practices;
    + **Authentication** (outermost). 

## Working directory structure

* Front controller: `public/index.php` -> all the non-file-or-directory traffic is redirected via standard URL rewrite rules.
* Initialization code: `bootstrap.php` -> responsible for loading our application settings and autoloader setup
* `/share`: contains data such as logs, configuration files, the SQLite databases and dump files, and the SSL certificates
* `/bin`: contains utility scripts that create the database and import some data using the provided .sql files.
* `/lib`: application code
* `/vendor`: 3rd party components - generated by composer

## Server config - SSL

Our API will be accessible only in HTTPS mode, with no redirection. This simplifies the authentication logic and prevents poorly configured clients to access non encrypted endpoints. The easiest and more logical way to set this up is acting directly on the web server or through a proxy server.

* Create a self signed certificate: https://www.sslshopper.com/article-how-to-create-and-install-an-apache-self-signed-certificate.html

* Windows - `C:\Windows\System32\drivers\etc\hosts`
        127.0.0.1           api-contacts.com

* Apache - `extra\httpd-vhosts.conf`:
    
    <Directory "/path/to/api_contacts/public">
        # Required for mod_rewrite in .htaccess
        AllowOverride FileInfo
        Options All -Indexes
        DirectoryIndex index.php index.shtml index.html
         
        <IfModule php5_module>
            # For Development only!
            php_flag display_errors On
        </IfModule>
     
        # Enable gzip compression
        <ifModule filter_module>
            AddOutputFilterByType DEFLATE application/json
        </ifModule>
         
        Order deny,allow
        Deny from all
        Allow from 127.0.0.1
    </Directory>

    <VirtualHost *:80>
        ServerAdmin webmaster@api-contacts.com
        DocumentRoot "/path/to/api_contacts/public"
        ServerName api-contacts.com
        
        <IfModule rewrite_module>
            RewriteEngine on
            ## Throw a 403 (forbidden) status for non secure requests
            RewriteCond %{HTTPS} off
            RewriteRule ^.*$ - [L,R=403]
        </IfModule>
    </VirtualHost>

    <VirtualHost *:443>
        ServerAdmin you@yourdomain.com
        DocumentRoot "/path/to/api_contacts/public"
        ServerName myapp.dev
    
        SSLEngine on
        SSLCertificateFile /path/to/api_contacts/share/ssl/mysitename.crt
        SSLCertificateKeyFile /path/to/api_contacts/share/ssl/mysitename.key
     
        SetEnv SLIM_MODE development
    </VirtualHost>

##